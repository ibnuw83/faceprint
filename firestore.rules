rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isOwner(uid) {
      return request.auth.uid == uid;
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // IMPLICIT DENY: By default, no one can access anything.
    
    // PUBLIC ACCESS: Settings can be read by anyone (for login/landing page).
    // This allows unauthenticated users to load app name, logo, landing content etc.
    match /settings/{docId} {
      allow get, list: if true; // Allow reading one or multiple setting documents
      allow write: if isAdmin();    // Only admins can change settings
    }

    // USER DATA ACCESS
    match /users/{uid} {
      // Admins can access any user profile
      // Users can access their own profile
      allow get: if isAdmin() || isOwner(uid);
      
      // Users can create their own document (on registration)
      // Admins can create new users
      allow create: if isOwner(uid) || isAdmin();

      // Users can update their own profile
      // Admins can update any profile
      allow update: if isAdmin() || isOwner(uid);
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }

    // ATTENDANCE DATA ACCESS
    match /attendance/{attendanceId} {
      // Admins can read all attendance records
      allow get, list: if isAdmin();
      
      // Authenticated users can create their own attendance records
      allow create: if request.auth != null && request.auth.uid == request.resource.data.uid;
      
      // Only admins can delete attendance records
      allow delete: if isAdmin();
      
      // No one can update an attendance record once created
      allow update: if false;
    }

    // DEPARTMENTS ACCESS
    match /departments/{departmentId} {
      // All authenticated users can read departments list
      allow get, list: if request.auth != null;
      
      // Only admins can create, update, or delete departments
      allow write: if isAdmin();
    }
    
    // LEAVE REQUESTS ACCESS
    match /leaveRequests/{requestId} {
      // Admins can see all leave requests
      // Users can see their own leave requests
      allow get, list: if isAdmin() || (request.auth != null && request.query.where.size() > 0 && request.query.where[0].field == 'uid' && request.query.where[0].value == request.auth.uid);
      
      // Authenticated users can create their own requests
      allow create: if request.auth != null && request.auth.uid == request.resource.data.uid;
      
      // Only admins can update (approve/reject) requests
      allow update: if isAdmin();
      
      // Only admins can delete requests
      allow delete: if isAdmin();
    }
  }
}
