
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isEmployee() {
      // Check if a user is an employee based on the custom claim 'role'.
      return request.auth.token.role == 'employee';
    }

    function isAdmin() {
      // Check if a user is an admin based on the custom claim 'role'.
      return request.auth.token.role == 'admin';
    }
    
    match /users/{userId} {
      // Admins can perform any action on any user document.
      allow read, write: if isAdmin();
      
      // Employees can only read and update their own user document.
      allow get, update: if request.auth.uid == userId;
    }
    
    match /settings/{settingId} {
        // Settings are public information (app name, colors, etc.)
        allow read: if true;
        // Only admins can change settings.
        allow write: if isAdmin();
    }
    
    match /departments/{departmentId} {
        // Only admins can manage departments.
        allow get, list, create, update, delete: if isAdmin();
    }
    
    match /leaveRequests/{requestId} {
      // Admins can read all requests and update their status.
      allow get, list, update: if isAdmin();

      // Employees can create requests for themselves and read their own requests.
      allow create: if request.auth.uid == request.resource.data.uid;
      allow read: if isEmployee() && request.auth.uid == resource.data.uid;
    }

    match /attendance/{attendanceId} {
      // Any authenticated user can create an attendance record (clock in/out).
      allow create: if request.auth != null;
      
      // An employee can query the attendance list, the query itself should filter by their employeeId.
      // An admin can also query the list.
      allow list, get: if isEmployee() || isAdmin();

      // Only an admin can delete attendance records.
      allow delete: if isAdmin();
    }
  }
}
