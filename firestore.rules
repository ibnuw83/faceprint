
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for Admin role
    function isAdmin() {
      // Check if the user is authenticated and if their document in 'users' collection has role 'admin'
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Settings are publicly readable by anyone, even unauthenticated users
    match /settings/{document=**} {
      allow read: if true;
      allow write: if isAdmin(); // Only admins can change settings
    }

    // Users can only manage their own data, but admins can manage anyone.
    // Anyone can create their own user document (e.g., during registration).
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId || isAdmin();
      allow create: if request.auth.uid == userId;
      allow delete: if isAdmin();
    }

    // Departments can only be managed by admins, but read by any authenticated user.
    match /departments/{deptId} {
      allow read: if request.auth != null;
      allow create, update, delete: if isAdmin();
    }

    // Attendance records can be created by any authenticated user for themselves.
    // Admins can read all records. Individual users can read their own.
    match /attendance/{attId} {
      allow create: if request.auth.uid != null && request.resource.data.uid == request.auth.uid;
      allow read, delete: if isAdmin() || (request.auth.uid != null && get(/databases/$(database)/documents/attendance/$(attId)).data.uid == request.auth.uid);
    }

    // Leave requests can be managed by the user who created them or by an admin.
    match /leaveRequests/{reqId} {
      allow create: if request.auth.uid != null && request.resource.data.uid == request.auth.uid;
      allow read: if isAdmin() || (request.auth.uid != null && get(/databases/$(database)/documents/leaveRequests/$(reqId)).data.uid == request.auth.uid);
      allow update, delete: if isAdmin();
    }
  }
}
