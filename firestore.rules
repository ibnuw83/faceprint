rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Aturan untuk koleksi "users"
    match /users/{userId} {
      // Siapa saja yang terotentikasi dapat membuat data profil mereka sendiri.
      allow create: if request.auth != null;
      // Pengguna hanya bisa membaca atau memperbarui data mereka sendiri.
      // Admin bisa membaca atau memperbarui data siapa saja.
      allow read, update: if request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      // Admin bisa menghapus pengguna.
      allow delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Aturan untuk koleksi "attendance"
    match /attendance/{docId} {
       // Pengguna yang terotentikasi dapat membuat catatan absensi
       allow create: if request.auth != null;
       // Pengguna hanya bisa melihat riwayat absensi mereka sendiri (berdasarkan employeeId)
       // Admin bisa melihat semua riwayat
       allow list, get: if resource.data.employeeId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.employeeId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
       // Admin dapat menghapus catatan absensi
       allow delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Aturan untuk koleksi "departments"
    match /departments/{docId} {
        // Hanya admin yang bisa mengelola departemen
        allow get, list, create, update, delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Aturan untuk koleksi "leaveRequests"
    match /leaveRequests/{docId} {
        // Pengguna bisa membuat pengajuan untuk diri mereka sendiri
        allow create: if request.resource.data.uid == request.auth.uid;
        // Pengguna bisa membaca pengajuan mereka sendiri, admin bisa membaca semua
        allow read: if resource.data.uid == request.auth.uid || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        // Hanya admin yang bisa menyetujui/menolak (update)
        allow update: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Aturan untuk dokumen pengaturan
    match /settings/{settingId} {
      // Siapa saja boleh membaca pengaturan (termasuk yang belum login)
      allow read: if true;
      // Hanya admin yang bisa mengubah pengaturan
      allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
